<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">
        <link rel="prefetch" href="../../_static/logo-text-light.svg" as="image">
        <link rel="prefetch" href="../../_static/logo-text-dark.svg" as="image">

    <link rel="shortcut icon" href="../../_static/logo-icon-dark.svg"><!-- Generated with Sphinx 8.1.3 and Furo 2025.12.19 -->
        <title>morfeus.multiwfn - ᴍᴏʀғᴇᴜs</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">ᴍᴏʀғᴇᴜs</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/logo-text-light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/logo-text-dark.svg" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes.html">Notes on usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command line interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bite_angle.html">Bite angle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../buried_volume.html">Buried volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cone_angle.html">Cone angle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conformer.html">Conformer tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dispersion.html">Dispersion descriptor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../local_force.html">Local force constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multiwfn.html">Multiwfn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyramidalization.html">Pyramidalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sasa.html">Solvent accessible surface area</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../solid_angle.html">Solid angle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sterimol.html">Sterimol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtb.html">XTB</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/morfeus.html">morfeus package</a><input aria-label="Toggle navigation of morfeus package" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.bite_angle.html">morfeus.bite_angle module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.buried_volume.html">morfeus.buried_volume module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.calculators.html">morfeus.calculators module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.cone_angle.html">morfeus.cone_angle module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.config.html">morfeus.config module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.conformer.html">morfeus.conformer module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.d3_data.html">morfeus.d3_data module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.data.html">morfeus.data module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.dispersion.html">morfeus.dispersion module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.geometry.html">morfeus.geometry module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.io.html">morfeus.io module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.local_force.html">morfeus.local_force module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.multiwfn.html">morfeus.multiwfn module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.plotting.html">morfeus.plotting module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.pyramidalization.html">morfeus.pyramidalization module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.qc.html">morfeus.qc module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.sasa.html">morfeus.sasa module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.solid_angle.html">morfeus.solid_angle module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.sterimol.html">morfeus.sterimol module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.typing.html">morfeus.typing module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.utils.html">morfeus.utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.visible_volume.html">morfeus.visible_volume module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/morfeus.xtb.html">morfeus.xtb module</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Source</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/digital-chemistry-laboratory/morfeus">GitHub</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for morfeus.multiwfn</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Multiwfn (http://sobereva.com/multiwfn/) interface code.</span>

<span class="sd">Uses pexpect for interactive control.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracebackType</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pexpect</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">morfeus.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">build_execution_env</span><span class="p">,</span>
    <span class="n">Import</span><span class="p">,</span>
    <span class="n">requires_dependency</span><span class="p">,</span>
    <span class="n">requires_executable</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">RealFunctionSetting</span> <span class="o">=</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">VectorFunctionSetting</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>

<span class="n">NUMBER_PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.?\d+(?:[Ee][-+]?\d+)?&quot;</span>
<span class="n">HOMO_LINE_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">rf</span><span class="s2">&quot;Orbital\s+(\d+)\s+is\s+HOMO,.*?(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+eV\b&quot;</span>
<span class="p">)</span>
<span class="n">LUMO_LINE_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">rf</span><span class="s2">&quot;Orbital\s+(\d+)\s+is\s+LUMO,.*?(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+eV\b&quot;</span>
<span class="p">)</span>
<span class="n">HOMO_LUMO_GAP_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;HOMO-LUMO gap:.*?(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+eV\b&quot;</span><span class="p">)</span>
<span class="n">ORBITAL_LINE_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">rf</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ^\s*</span>
<span class="s2">    (?:Orb:\s*)?</span>
<span class="s2">    (?P&lt;index&gt;\d+)</span>
<span class="s2">    (?:\s+\(\s*\d+\s*\))?</span>
<span class="s2">    \s+</span>
<span class="s2">    (?:Ene|E)\(au/eV\):</span>
<span class="s2">    \s*</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">\s+(?P&lt;energy_ev&gt;</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">    \s+Occ:\s*(?P&lt;occupation&gt;</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">    \s+Typ(?:e)?\s*:\s*(?P&lt;orbital_type&gt;A\+B|A|B)\b</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">SINGLE_DETERMINANT_WFN_ERROR_TEXT</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Only closed-shell single-determinant wavefunction is supported by this function&quot;</span>
<span class="p">)</span>
<span class="c1"># Multiwfn variants differ slightly in spacing/case/hyphenation; match both forms.</span>
<span class="n">SINGLE_DETERMINANT_WFN_ERROR_PATTERN</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">SINGLE_DETERMINANT_WFN_ERROR_TEXT</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;|Only\s+closed-shell\s+single\s+determinant\s+wavefunction\s+&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;is\s+supported\s+by\s+this\s+function&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;|single[-\s]?determinant\s+wavefunction\s+is\s+supported\s+by\s+this\s+function&quot;</span>
<span class="p">)</span>
<span class="n">SINGLE_DETERMINANT_WFN_ERROR_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">SINGLE_DETERMINANT_WFN_ERROR_PATTERN</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
<span class="p">)</span>


<span class="n">REAL_SPACE_FUNCTIONS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;rho&quot;</span><span class="p">:</span> <span class="s2">&quot;1 Electron density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rho_grad_norm&quot;</span><span class="p">:</span> <span class="s2">&quot;2 Gradient norm of rho&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rho_lapl&quot;</span><span class="p">:</span> <span class="s2">&quot;3 Laplacian of rho&quot;</span><span class="p">,</span>
    <span class="s2">&quot;spin_density&quot;</span><span class="p">:</span> <span class="s2">&quot;5 Electron spin density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kr&quot;</span><span class="p">:</span> <span class="s2">&quot;6 Hamiltonian kinetic energy density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gr&quot;</span><span class="p">:</span> <span class="s2">&quot;7 Lagrangian kinetic energy density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esp_nuclear&quot;</span><span class="p">:</span> <span class="s2">&quot;8 Electrostatic potential from nuclear charges&quot;</span><span class="p">,</span>
    <span class="s2">&quot;elf&quot;</span><span class="p">:</span> <span class="s2">&quot;9 Electron localization function&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lol&quot;</span><span class="p">:</span> <span class="s2">&quot;10 Localized orbital locator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lie&quot;</span><span class="p">:</span> <span class="s2">&quot;11 Local information entropy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esp_total&quot;</span><span class="p">:</span> <span class="s2">&quot;12 Total electrostatic potential&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rdg&quot;</span><span class="p">:</span> <span class="s2">&quot;13 Reduced density gradient&quot;</span><span class="p">,</span>  <span class="c1"># only for grid</span>
    <span class="s2">&quot;rdg_pro&quot;</span><span class="p">:</span> <span class="s2">&quot;14 RDG with promolecular approximation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sign&quot;</span><span class="p">:</span> <span class="s2">&quot;15 Sign&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sign_pro&quot;</span><span class="p">:</span> <span class="s2">&quot;16 Sign&quot;</span><span class="p">,</span>
    <span class="s2">&quot;correlation_alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;17 Correlation hole for alpha&quot;</span><span class="p">,</span>
    <span class="s2">&quot;alie&quot;</span><span class="p">:</span> <span class="s2">&quot;18 Average local ionization energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;deltag_pro&quot;</span><span class="p">:</span> <span class="s2">&quot;22 Delta-g&quot;</span><span class="p">,</span>
    <span class="s2">&quot;deltag_hirsh&quot;</span><span class="p">:</span> <span class="s2">&quot;23 Delta-g&quot;</span><span class="p">,</span>
    <span class="s2">&quot;iri&quot;</span><span class="p">:</span> <span class="s2">&quot;24 Interaction region indicator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vdw&quot;</span><span class="p">:</span> <span class="s2">&quot;25 van der Waals potential&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">USER_REAL_FUNCTIONS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RealFunctionSetting</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;alpha_density&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># open</span>
    <span class="s2">&quot;beta_density&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># open</span>
    <span class="s2">&quot;spatial_extent_integrand_r2rho&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;weizsaecker_potential&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;weizsaecker_functional_integrand&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;radial_distribution_rdf_4pi_r2_rho&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;local_temperature_kb_units&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;PNAS, 81, 8028&quot;</span><span class="p">),</span>
    <span class="s2">&quot;avg_local_esp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Phys., 72, 3027&quot;</span><span class="p">),</span>
    <span class="s2">&quot;shape_function_rho_over_N&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;virial_field_potential_energy&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;electron_energy&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="s2">&quot;local_nuclear_attraction_energy&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s2">&quot;kinetic_energy_per_electron_G_over_rho&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
    <span class="s2">&quot;electron_esp_Vele&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
    <span class="s2">&quot;bond_metallicity&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;J. Phys.: Condens. Matter, 14, 10251&quot;</span><span class="p">),</span>
    <span class="s2">&quot;dimensionless_bond_metallicity&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;Chem. Phys. Lett., 471, 174&quot;</span><span class="p">),</span>
    <span class="s2">&quot;energy_density_per_electron&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Phys., 117, 5529 (2002)&quot;</span><span class="p">),</span>
    <span class="s2">&quot;region_of_slow_electrons_RoSE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;Chem. Phys. Lett., 582, 144 (2013)&quot;</span><span class="p">),</span>
    <span class="s2">&quot;SEDD&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Theory Comput., 10, 3745 (2014)&quot;</span><span class="p">),</span>
    <span class="s2">&quot;DORI&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Theory Comput., 10, 3745 (2014)&quot;</span><span class="p">),</span>
    <span class="s2">&quot;dft_linear_response_kernel&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;Phys. Chem. Chem. Phys., 14, 3960&quot;</span><span class="p">),</span>  <span class="c1"># closed</span>
    <span class="s2">&quot;electronic_momentum_fluctuation_magnitude&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;Theor. Chim. Acc., 127, 393&quot;</span><span class="p">),</span>
    <span class="s2">&quot;thomas_fermi_functional_integrand&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="s2">&quot;J. Mol. Model., 9, 342&quot;</span><span class="p">),</span>
    <span class="s2">&quot;local_electron_affinity_EAL&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="s2">&quot;J. Mol. Model., 9, 342&quot;</span><span class="p">),</span>
    <span class="s2">&quot;local_mulliken_electronegativity&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="s2">&quot;J. Mol. Model., 9, 342&quot;</span><span class="p">),</span>
    <span class="s2">&quot;local_hardness&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">29</span><span class="p">,</span> <span class="s2">&quot;J. Mol. Model., 9, 342&quot;</span><span class="p">),</span>
    <span class="s2">&quot;ellipticity_of_density_hessian&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="s2">&quot;eta_index&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="mi">31</span><span class="p">,</span>
        <span class="s2">&quot;Angew. Chem. Int. Ed., 53, 2766 (2014); J. Phys. Chem. A, 114, 552 (2010)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;modified_eta_index_tian_lu&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;paem_pair_density_muller_xc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="s2">&quot;J. Comput. Chem., 35, 965 (2014)&quot;</span><span class="p">),</span>
    <span class="s2">&quot;paem_dft_xc_closedshell&quot;</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>  <span class="c1"># closed</span>
    <span class="s2">&quot;G_over_V_ratio_at_bcp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Phys., 117, 5529 (2002)&quot;</span><span class="p">),</span>
    <span class="s2">&quot;on_top_pair_density_pi_rr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="s2">&quot;Int. J. Quantum Chem., 61, 197 (1995)&quot;</span><span class="p">),</span>
    <span class="c1"># &quot;angle_hessvec2_vs_plane_normal&quot;: (&quot;38&quot;, &quot;J. Phys. Chem. A, 115, 12512 (2011)&quot;),</span>
    <span class="s2">&quot;electrostatic_potential_excluding_nucleus_K&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="mi">39</span><span class="p">,</span>
        <span class="s2">&quot;J. Phys. Chem. A, 118, 1697 (2014)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;steric_energy_density_weizsaecker_integrand&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
    <span class="s2">&quot;steric_potential&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Phys., 126, 244103&quot;</span><span class="p">),</span>
    <span class="s2">&quot;steric_charge&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Phys., 126, 244103&quot;</span><span class="p">),</span>
    <span class="s2">&quot;steric_force_magnitude&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Phys., 126, 244103&quot;</span><span class="p">),</span>
    <span class="s2">&quot;damped_steric_potential&quot;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span>
    <span class="s2">&quot;steric_force_from_damped_steric_potential&quot;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
    <span class="s2">&quot;directly_damped_steric_force&quot;</span><span class="p">:</span> <span class="mi">46</span><span class="p">,</span>
    <span class="s2">&quot;shannon_entropy&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s2">&quot;fisher_information&quot;</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span>
    <span class="s2">&quot;second_fisher_information&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="s2">&quot;J. Chem. Phys., 126, 191107&quot;</span><span class="p">),</span>
    <span class="s2">&quot;ghosh_entropy_GBP_local_entropy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">53</span><span class="p">,</span> <span class="s2">&quot;PNAS, 81, 8028&quot;</span><span class="p">),</span>
    <span class="s2">&quot;ghosh_entropy_GBP_alt_kinetic_t&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="s2">&quot;PNAS, 81, 8028&quot;</span><span class="p">),</span>
    <span class="s2">&quot;renyi_entropy_quadratic_integrand_rho2&quot;</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span>
    <span class="s2">&quot;renyi_entropy_cubic_integrand_rho3&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
    <span class="s2">&quot;pauli_potential&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;Comput. Theor. Chem., 1006, 92–99&quot;</span><span class="p">),</span>  <span class="c1"># closed</span>
    <span class="s2">&quot;pauli_force_magnitude&quot;</span><span class="p">:</span> <span class="mi">61</span><span class="p">,</span>  <span class="c1"># closed</span>
    <span class="s2">&quot;pauli_charge&quot;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span>  <span class="c1"># closed</span>
    <span class="s2">&quot;quantum_potential&quot;</span><span class="p">:</span> <span class="mi">63</span><span class="p">,</span>
    <span class="s2">&quot;quantum_force_magnitude&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
    <span class="s2">&quot;quantum_charge&quot;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span>
    <span class="s2">&quot;electrostatic_force_magnitude&quot;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span>
    <span class="s2">&quot;electrostatic_charge&quot;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span>
    <span class="s2">&quot;energy_density_electrostatic_sbl&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
    <span class="s2">&quot;energy_density_quantum_sbl_hamiltonian&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">,</span>
    <span class="s2">&quot;energy_density_quantum_sbl_lagrangian&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">69</span><span class="p">,</span>
    <span class="s2">&quot;phase_space_fisher_information_PS_FID&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;Chem. Phys., 435, 49 (2014)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;electron_linear_momentum_magnitude&quot;</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span>
    <span class="s2">&quot;magnetic_dipole_moment_magnitude&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">78</span><span class="p">,</span> <span class="s2">&quot;Theoret. Chim. Acta, 6, 341&quot;</span><span class="p">),</span>
    <span class="s2">&quot;grad_norm_energy_density&quot;</span><span class="p">:</span> <span class="mi">79</span><span class="p">,</span>
    <span class="s2">&quot;lapl_energy_density&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s2">&quot;local_electron_correlation&quot;</span><span class="p">:</span> <span class="mi">87</span><span class="p">,</span>
    <span class="s2">&quot;local_dyn_correlation&quot;</span><span class="p">:</span> <span class="mi">88</span><span class="p">,</span>
    <span class="s2">&quot;local_nondyn_correlation&quot;</span><span class="p">:</span> <span class="mi">89</span><span class="p">,</span>
    <span class="s2">&quot;vdw&quot;</span><span class="p">:</span> <span class="mi">92</span><span class="p">,</span>
    <span class="s2">&quot;repulsion&quot;</span><span class="p">:</span> <span class="mi">93</span><span class="p">,</span>
    <span class="s2">&quot;dispersion&quot;</span><span class="p">:</span> <span class="mi">94</span><span class="p">,</span>
    <span class="s2">&quot;fplus&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>
    <span class="s2">&quot;fminus&quot;</span><span class="p">:</span> <span class="mi">96</span><span class="p">,</span>
    <span class="s2">&quot;fnull&quot;</span><span class="p">:</span> <span class="mi">97</span><span class="p">,</span>
    <span class="s2">&quot;fdual&quot;</span><span class="p">:</span> <span class="mi">98</span><span class="p">,</span>
    <span class="s2">&quot;iri&quot;</span><span class="p">:</span> <span class="mi">99</span><span class="p">,</span>
    <span class="s2">&quot;disequilibrium_rho2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;Int. J. Quantum Chem., 113, 2589 (2013)&quot;</span><span class="p">),</span>
    <span class="s2">&quot;positive_part_of_ESP&quot;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="s2">&quot;negative_part_of_ESP&quot;</span><span class="p">:</span> <span class="mi">102</span><span class="p">,</span>
    <span class="s2">&quot;magnitude_electric_field&quot;</span><span class="p">:</span> <span class="mi">103</span><span class="p">,</span>
    <span class="s2">&quot;ultrastrong_interaction&quot;</span><span class="p">:</span> <span class="mi">819</span><span class="p">,</span>
    <span class="s2">&quot;bni&quot;</span><span class="p">:</span> <span class="mi">820</span><span class="p">,</span>
    <span class="s2">&quot;shubin_rho_over_grad&quot;</span><span class="p">:</span> <span class="mi">821</span><span class="p">,</span>
    <span class="s2">&quot;local_hf_exchange_energy&quot;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="s2">&quot;dft_xc&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="s2">&quot;dft_xc_closed&quot;</span><span class="p">:</span> <span class="mi">1100</span><span class="p">,</span>  <span class="c1"># closed</span>
    <span class="s2">&quot;dft_xc_alpha&quot;</span><span class="p">:</span> <span class="mi">1101</span><span class="p">,</span>  <span class="c1"># open</span>
    <span class="s2">&quot;dft_xc_beta&quot;</span><span class="p">:</span> <span class="mi">1102</span><span class="p">,</span>  <span class="c1"># open</span>
<span class="p">}</span>

<span class="n">VECTORS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VectorFunctionSetting</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">901</span><span class="p">,</span> <span class="mi">902</span><span class="p">),</span>
    <span class="s2">&quot;dipole_integrand_minus&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
    <span class="s2">&quot;electron_linear_momentum&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">),</span>
    <span class="s2">&quot;magnetic_dipole_moment&quot;</span><span class="p">:</span> <span class="p">((</span><span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">),</span> <span class="s2">&quot;Theoret. Chim. Acta, 6, 341&quot;</span><span class="p">),</span>
    <span class="s2">&quot;hamiltonian_kinetic_energy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">81</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">),</span>
    <span class="s2">&quot;lagrangian_kinetic_energy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">86</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">REAL_FUNCTIONS_EXPENSIVE</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;electron_esp_Vele&quot;</span><span class="p">,</span>
    <span class="s2">&quot;avg_local_esp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;electrostatic_potential_excluding_nucleus_K&quot;</span><span class="p">,</span>
    <span class="s2">&quot;paem_pair_density_muller_xc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;paem_dft_xc_closedshell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pauli_force_magnitude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pauli_charge&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pauli_potential&quot;</span><span class="p">,</span>
    <span class="s2">&quot;energy_density_electrostatic_sbl&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantum_potential&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantum_force_magnitude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quantum_charge&quot;</span><span class="p">,</span>
    <span class="s2">&quot;electrostatic_force_magnitude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;electrostatic_charge&quot;</span><span class="p">,</span>
    <span class="s2">&quot;positive_part_of_ESP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;negative_part_of_ESP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;magnitude_electric_field&quot;</span><span class="p">,</span>
    <span class="s2">&quot;steric_charge&quot;</span><span class="p">,</span>
    <span class="s2">&quot;esp_total&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ALL_FUNCTIONS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">REAL_SPACE_FUNCTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">USER_REAL_FUNCTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">VECTORS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="p">)</span>
<span class="n">FAST_FUNCTIONS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">ALL_FUNCTIONS</span> <span class="o">-</span> <span class="n">REAL_FUNCTIONS_EXPENSIVE</span>

<span class="n">CHARGE_MODELS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;hirshfeld&quot;</span><span class="p">:</span> <span class="s2">&quot;1 Hirshfeld atomic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vdd&quot;</span><span class="p">:</span> <span class="s2">&quot;2 Voronoi deformation density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mulliken&quot;</span><span class="p">:</span> <span class="s2">&quot;5 Mulliken atom &amp; basis function&quot;</span><span class="p">,</span>
    <span class="s2">&quot;adch&quot;</span><span class="p">:</span> <span class="s2">&quot;11 Atomic dipole corrected Hirshfeld&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cm5&quot;</span><span class="p">:</span> <span class="s2">&quot;16 CM5 atomic charge&quot;</span><span class="p">,</span>
    <span class="s2">&quot;12cm5&quot;</span><span class="p">:</span> <span class="s2">&quot;-16 Generate 1.2&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">CHARGE_MODEL_CITATIONS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;hirshfeld&quot;</span><span class="p">:</span> <span class="s2">&quot;Theor. Chim. Acta. (Berl), 44, 129-138 (1977)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vdd&quot;</span><span class="p">:</span> <span class="s2">&quot;J. Comput. Chem., 25, 189.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;adch&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s2">&quot;Tian Lu, Feiwu Chen, Atomic dipole moment corrected Hirshfeld population &quot;</span>
        <span class="s2">&quot;method, J. Theor. Comput. Chem., 11, 163 (2012)&quot;</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="n">SURFACE_MODELS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;esp&quot;</span><span class="p">:</span> <span class="s2">&quot;1 Electrostatic potential&quot;</span><span class="p">,</span>
    <span class="s2">&quot;alie&quot;</span><span class="p">:</span> <span class="s2">&quot;2 Average local ionization energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lea&quot;</span><span class="p">:</span> <span class="s2">&quot;4 Local electron affinity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;leae&quot;</span><span class="p">:</span> <span class="s2">&quot;-4 Local electron attachment energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;electron&quot;</span><span class="p">:</span> <span class="s2">&quot;11 Electron density&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sign&quot;</span><span class="p">:</span> <span class="s2">&quot;12 Sign&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">BOND_ORDER_MODELS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mayer&quot;</span><span class="p">:</span> <span class="s2">&quot;1 Mayer bond order analysis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wiberg&quot;</span><span class="p">:</span> <span class="s2">&quot;3 Wiberg bond order analysis in Lowdin orthogonalized basis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mulliken&quot;</span><span class="p">:</span> <span class="s2">&quot;4 Mulliken bond order&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fuzzy&quot;</span><span class="p">:</span> <span class="s2">&quot;7 Fuzzy bond order analysis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;laplacian&quot;</span><span class="p">:</span> <span class="s2">&quot;8 Laplacian bond order&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">MISSING_BASIS_FUNCTION_INFORMATION_ERROR</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;The input file you used does not contain basis function information!&quot;</span>
<span class="p">)</span>
<span class="n">WFN_UNSUPPORTED_CHARGE_MODELS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mulliken&quot;</span><span class="p">}</span>
<span class="n">WFN_UNSUPPORTED_BOND_ORDER_MODELS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mayer&quot;</span><span class="p">,</span> <span class="s2">&quot;wiberg&quot;</span><span class="p">,</span> <span class="s2">&quot;mulliken&quot;</span><span class="p">}</span>

<span class="n">GRID_QUALITIES</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="s2">&quot;1 Low quality grid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;medium&quot;</span><span class="p">:</span> <span class="s2">&quot;2 Medium quality grid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="s2">&quot;3 High quality grid&quot;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="CommandStep">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.CommandStep">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CommandStep</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Command step with optional flag for conditional execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmd: Command to send</span>
<span class="sd">        expect: Pattern to expect before sending</span>
<span class="sd">        optional: If True, only execute if expect pattern is found in output;</span>
<span class="sd">                  if False, always execute regardless</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">optional</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="WaitProgress">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.WaitProgress">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WaitProgress</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wait for a progress bar to complete.&quot;&quot;&quot;</span>

    <span class="n">max_wait</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span></div>



<div class="viewcode-block" id="ProgressState">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.ProgressState">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProgressState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Track progress bar waiting state.&quot;&quot;&quot;</span>

    <span class="n">last_activity</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">saw_progress</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">saw_please_wait</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">idle_timeout</span><span class="p">:</span> <span class="nb">float</span></div>



<div class="viewcode-block" id="MultiwfnRunResult">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.MultiwfnRunResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiwfnRunResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result from a single Multiwfn run.&quot;&quot;&quot;</span>

    <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">workdir</span><span class="p">:</span> <span class="n">Path</span></div>



<div class="viewcode-block" id="MultiwfnResults">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.MultiwfnResults">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiwfnResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cached Multiwfn results.&quot;&quot;&quot;</span>

    <span class="n">charges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">surfaces</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">atomic_descriptors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">grid_descriptors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">electric_moments</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gap</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bond_orders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fukui</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">superdelocalizabilities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">localization</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">atomic_vector_descriptors</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">citations</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span></div>



<span class="nd">@requires_dependency</span><span class="p">([</span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;pexpect&quot;</span><span class="p">)],</span> <span class="nb">globals</span><span class="p">())</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_PexpectSession</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pexpect session manager for Multiwfn.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">workdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span>
            <span class="n">base_command</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">workdir</span><span class="p">),</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expect_timeout</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_command_pos</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_coerce_output_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize pexpect output chunks to text for transcript storage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">chunk</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append normalized output chunk to transcript.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coerce_output_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read available output without blocking.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">read_nonblocking</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_wait</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for a progress bar to appear and complete.&quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_progress_state</span><span class="p">(</span><span class="n">max_wait</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Waiting for progress bar &quot;</span> <span class="sa">f</span><span class="s2">&quot;(max_idle_wait=</span><span class="si">{</span><span class="n">max_wait</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_progress_chunk</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_stop_on_timeout</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                    <span class="k">return</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="s2">&quot;EOF&quot;</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_progress_chunk</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
                <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send command to process.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmd: Command to send</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Sent: </span><span class="si">{</span><span class="n">cmd</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_command_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_has_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if text contains a progress bar and extract percentage.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: Text chunk to inspect.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (has_progress_bar, percentage).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bar_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([#=\-]+)\]&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bar_match</span><span class="p">:</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="n">bar_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bar</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">100.0</span>
        <span class="c1"># Match patterns like: &quot;Progress: [###---] 14.3 %&quot; or &quot;14.3 %&quot;</span>
        <span class="n">progress_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Progress:\s*\[[#-]+\]\s+([\d.]+)\s*%&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">progress_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">percentage</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">percentage</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for pattern. Returns True on match, False on timeout.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Expecting: </span><span class="si">{</span><span class="n">pattern</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_expect_timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Got match&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_available</span><span class="p">()</span>
            <span class="n">recent_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_since_last_command</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[WARN] Timeout (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_expect_timeout</span><span class="si">}</span><span class="s2">s) waiting for: </span><span class="si">{</span><span class="n">pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recent output: </span><span class="si">{</span><span class="n">recent_output</span><span class="p">[</span><span class="o">-</span><span class="mi">500</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARN] EOF while waiting for: </span><span class="si">{</span><span class="n">pattern</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">try_expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to match a pattern with short timeout. Silent on timeout.</span>

<span class="sd">        Does not extend timeout for progress bars (use expect() for that).</span>

<span class="sd">        Args:</span>
<span class="sd">            pattern: Regular expression to match.</span>
<span class="sd">            timeout: Timeout in seconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the pattern is matched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Try expecting: </span><span class="si">{</span><span class="n">pattern</span><span class="si">!r}</span><span class="s2"> (timeout=</span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Got match&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_available</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Pattern not found (optional)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">:</span>
            <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_output_chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
            <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_output_chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] EOF while checking optional pattern&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">before</span><span class="si">}{</span><span class="n">after</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for process to exit.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[WARN] Timeout waiting for EOF&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_recent_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_chunks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">max_chars</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get recent output for debugging.&quot;&quot;&quot;</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="p">[</span><span class="o">-</span><span class="n">n_chunks</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_chunks</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span>
        <span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="n">max_chars</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_chars</span> <span class="k">else</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_output_since_last_command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get output since last command.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_command_pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_command_pos</span> <span class="p">:])</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Full session transcript.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transcript</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_robust</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute command with optional expect.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_robust</span> <span class="ow">and</span> <span class="n">expect</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">expect</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
                <span class="c1"># Some Multiwfn builds emit the single-determinant warning and then</span>
                <span class="c1"># change prompts abruptly. Surface this domain error instead of a</span>
                <span class="c1"># generic prompt-mismatch RuntimeError.</span>
                <span class="n">transcript</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span>
                <span class="n">buffered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_since_last_command</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">SINGLE_DETERMINANT_WFN_ERROR_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">buffered</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">transcript</span> <span class="ow">and</span> <span class="n">SINGLE_DETERMINANT_WFN_ERROR_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">transcript</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">SINGLE_DETERMINANT_WFN_ERROR_TEXT</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected pattern not found before command </span><span class="si">{</span><span class="n">cmd</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_robust</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_available</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_has_pattern_in_buffered_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">debug_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if pattern is present in buffered output.&quot;&quot;&quot;</span>
        <span class="n">buffered_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_since_last_command</span><span class="p">()</span>
        <span class="n">pattern_found</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">buffered_output</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="ow">and</span> <span class="n">pattern_found</span> <span class="ow">and</span> <span class="n">debug_message</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">debug_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pattern_found</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_step_execution</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">CommandStep</span><span class="p">,</span> <span class="n">use_robust</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve whether a command step should run and which expect to use.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">expect</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">optional</span><span class="p">:</span>
            <span class="n">pattern_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_expect</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">expect</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_found</span><span class="p">:</span>
                <span class="n">pattern_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_pattern_in_buffered_output</span><span class="p">(</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">expect</span><span class="p">,</span>
                    <span class="s2">&quot;[DEBUG] Optional pattern found in buffered output&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;found&quot;</span> <span class="k">if</span> <span class="n">pattern_found</span> <span class="k">else</span> <span class="s2">&quot;not found&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Optional pattern </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">expect</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_found</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
            <span class="c1"># Avoid matching the same already-consumed pattern twice.</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">use_robust</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_pattern_in_buffered_output</span><span class="p">(</span>
            <span class="n">item</span><span class="o">.</span><span class="n">expect</span><span class="p">,</span> <span class="s2">&quot;[DEBUG] Required pattern found in buffered output&quot;</span>
        <span class="p">):</span>
            <span class="c1"># Avoid expecting the same prompt again if it was already consumed.</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">expect</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">CommandStep</span> <span class="o">|</span> <span class="n">WaitProgress</span><span class="p">,</span> <span class="n">use_robust</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process command step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_command</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_robust</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">WaitProgress</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Executing WaitProgress (max_wait=</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">max_wait</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_progress</span><span class="p">(</span><span class="n">max_wait</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">max_wait</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">should_execute</span><span class="p">,</span> <span class="n">command_expect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_step_execution</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">use_robust</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">should_execute</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">cmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_command</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">command_expect</span><span class="p">,</span> <span class="n">use_robust</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_progress_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_wait</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProgressState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize progress waiting state.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_wait: Maximum idle time in seconds before timing out.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Initialized progress waiting state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ProgressState</span><span class="p">(</span>
            <span class="n">last_activity</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">saw_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">saw_please_wait</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">idle_timeout</span><span class="o">=</span><span class="n">max_wait</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_progress_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read output chunk while waiting for progress.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Chunk string, &quot;EOF&quot; on end-of-file, or None on timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child</span><span class="o">.</span><span class="n">read_nonblocking</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] No new output while waiting for progress&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] EOF reached while waiting for progress&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;EOF&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_stop_on_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ProgressState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if progress waiting should stop due to inactivity.</span>

<span class="sd">        Args:</span>
<span class="sd">            state: Current progress waiting state.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if waiting should stop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">idle_timeout</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">saw_progress</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">idle_timeout</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">state</span><span class="o">.</span><span class="n">last_activity</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">saw_progress</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] No progress updates within idle timeout; done&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] No progress observed within timeout; done&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_progress_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ProgressState</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle a progress chunk and return True when waiting is done.</span>

<span class="sd">        Args:</span>
<span class="sd">            state: Current progress waiting state.</span>
<span class="sd">            chunk: Output chunk from the process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True when waiting should stop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_transcript</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Read chunk while waiting: </span><span class="si">{</span><span class="n">chunk</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">last_activity</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;please wait&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">state</span><span class="o">.</span><span class="n">saw_please_wait</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] &#39;Please wait&#39; seen while waiting&quot;</span><span class="p">)</span>
        <span class="n">has_progress</span><span class="p">,</span> <span class="n">current_progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_progress_bar</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_progress</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">saw_progress</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Progress bar no longer detected; done&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">state</span><span class="o">.</span><span class="n">saw_progress</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">progress_info</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">current_progress</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">if</span> <span class="n">current_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Progress bar detected</span><span class="si">{</span><span class="n">progress_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_progress</span> <span class="o">&gt;=</span> <span class="mf">100.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Progress bar completed (&gt;=100%)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="Multiwfn">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Multiwfn</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multiwfn interface using pexpect for interactive control.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path: Path to molden/wfn file from xtb or other QM program.</span>
<span class="sd">        run_path: Directory for output files. Defaults to temporary directory</span>
<span class="sd">            that is cleaned up when the instance is closed or garbage-collected.</span>
<span class="sd">        robust_mode: If True, wait for expect patterns between commands (slower but</span>
<span class="sd">            safer).</span>
<span class="sd">            If False, send commands without waiting (faster but may desync).</span>
<span class="sd">        debug: If True, print debug info including sent commands and expect patterns.</span>
<span class="sd">        env_variables: Environment variables to use for the Multiwfn process.</span>
<span class="sd">        max_wait: Maximum time to wait for progress updates in seconds.</span>
<span class="sd">        has_spin: Spin state. If None, detect from file for wavefunction inputs</span>
<span class="sd">            (True=open-shell, False=closed-shell). For .cub/.grd inputs, spin</span>
<span class="sd">            state is left undefined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">run_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">robust_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">env_variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_wait</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">has_spin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">run_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">:</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;morfeus_multiwfn_&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_robust_mode</span> <span class="o">=</span> <span class="n">robust_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_variables</span> <span class="o">=</span> <span class="n">env_variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">MultiwfnResults</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings_ini_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span> <span class="o">=</span> <span class="n">max_wait</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Both following papers ***MUST BE CITED IN MAIN TEXT*** if Multiwfn is used:</span>
            <span class="c1"># See &quot;How to cite Multiwfn.pdf&quot; in Multiwfn binary package for more</span>
            <span class="c1"># information.</span>
            <span class="p">(</span>
                <span class="s2">&quot;Tian Lu, Feiwu Chen, J. Comput. Chem., 33, 580 (2012) DOI: &quot;</span>
                <span class="s2">&quot;10.1002/jcc.22885&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;Tian Lu, J. Chem. Phys., 161, 082503 (2024) DOI: 10.1063/5.0216272&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="o">=</span> <span class="n">has_spin</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;.cub&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.grd&quot;</span><span class="p">,</span>
        <span class="p">}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_spin_state</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_spin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the molden file and parse the multiplicity.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">([</span><span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">)])</span>
        <span class="n">mult_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Expected multiplicity:\s*(\d+)&quot;</span>

        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">mult_pattern</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not detect multiplicity from the file.&quot;</span><span class="p">)</span>

        <span class="n">mult</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mult</span> <span class="o">&gt;</span> <span class="mi">1</span>

<div class="viewcode-block" id="Multiwfn.load_settingini">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.load_settingini">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_settingini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load custom settings.ini file for all future runs.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path: Path to custom settings.ini file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If settings.ini does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">settings_path</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;settings.ini&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Settings file not found: </span><span class="si">{</span><span class="n">settings_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings_ini_path</span> <span class="o">=</span> <span class="n">settings_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_settings_ini</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="Multiwfn.load_settingsini">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.load_settingsini">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_settingsini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Backward-compatible alias for load_settingini().&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_settingini</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="Multiwfn.close">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up temporary working directory, if created.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Multiwfn&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exc_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">traceback</span><span class="p">:</span> <span class="n">TracebackType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_copy_settings_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy configured settings.ini into a working directory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings_ini_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">target_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="s2">&quot;settings.ini&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings_ini_path</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_commands_change_iuserfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjust the iuserfunc setting.</span>

<span class="sd">        Refer to a complete list (ctrl F: !Below functions can be selected by</span>
<span class="sd">        &quot;iuserfunc&quot; parameter):</span>
<span class="sd">        https://github.com/foxtran/MultiWFN/blob/master/src/function.f90</span>

<span class="sd">        Args:</span>
<span class="sd">            function: User-defined function index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Command steps to apply iuserfunc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;1000&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;300 Other functions&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;2 Set iuserfunc&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">function</span><span class="p">),</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;Input index of the user-defined function&quot;</span>
            <span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_fuzzy_integration_commands</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">menu_cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">menu_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prefix_commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span> <span class="o">|</span> <span class="n">WaitProgress</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build command sequence for fuzzy atomic space integration.&quot;&quot;&quot;</span>
        <span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span> <span class="o">|</span> <span class="n">WaitProgress</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prefix_commands</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;15&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;15 Fuzzy atomic space analysis&quot;</span><span class="p">),</span>
                <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;1 Perform integration in fuzzy atomic spaces&quot;</span><span class="p">),</span>
                <span class="n">CommandStep</span><span class="p">(</span><span class="n">menu_cmd</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">menu_pattern</span><span class="p">),</span>
                <span class="n">WaitProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span><span class="p">),</span>
                <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Return&quot;</span><span class="p">),</span>
                <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">commands</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_user_function</span><span class="p">(</span>
        <span class="n">function_setting</span><span class="p">:</span> <span class="n">RealFunctionSetting</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a user-defined scalar function setting.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function_setting</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">function_setting</span>
        <span class="k">return</span> <span class="n">function_setting</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_vector_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse vector function settings and cache citation if present.&quot;&quot;&quot;</span>
        <span class="n">vector_setting</span> <span class="o">=</span> <span class="n">VECTORS</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector_setting</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vector_setting</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">functions</span> <span class="o">=</span> <span class="n">vector_setting</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vector_setting</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">functions</span>
        <span class="k">return</span> <span class="n">vector_setting</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create working directory.&quot;&quot;&quot;</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_path</span> <span class="o">/</span> <span class="n">subdir</span> <span class="k">if</span> <span class="n">subdir</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_path</span>
        <span class="n">workdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Copy a custom settings.ini file from run_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_settings_ini</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">workdir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set environment variables for Multiwfn execution.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">build_execution_env</span><span class="p">(</span><span class="n">env_variables</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_variables</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_option</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize option keys to lower-case.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_wfn_input</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True when the current input file is a .wfn file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.wfn&quot;</span>

<div class="viewcode-block" id="Multiwfn.list_options">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.list_options">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List available option names for common Multiwfn analyses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;charges&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">CHARGE_MODELS</span><span class="p">),</span>
            <span class="s2">&quot;surface&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">SURFACE_MODELS</span><span class="p">),</span>
            <span class="s2">&quot;bond_order&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">BOND_ORDER_MODELS</span><span class="p">),</span>
            <span class="s2">&quot;grid_quality&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">GRID_QUALITIES</span><span class="p">),</span>
            <span class="s2">&quot;descriptors&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ALL_FUNCTIONS</span><span class="p">),</span>
            <span class="s2">&quot;descriptors_fast&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">FAST_FUNCTIONS</span><span class="p">),</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Multiwfn.get_citations">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_citations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_citations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all collected citations for the current object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span><span class="p">)</span></div>


    <span class="nd">@requires_executable</span><span class="p">([</span><span class="s2">&quot;Multiwfn&quot;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_commands</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">CommandStep</span> <span class="o">|</span> <span class="n">WaitProgress</span><span class="p">],</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MultiwfnRunResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run Multiwfn with a custom command sequence.</span>

<span class="sd">        Args:</span>
<span class="sd">            commands: Sequence of commands (strings or CommandStep objects).</span>
<span class="sd">            subdir: Subdirectory within run_path to store results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            MultiwfnRunResult with stdout, workdir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_workdir</span><span class="p">(</span><span class="n">subdir</span><span class="p">)</span>

        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_env</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">_PexpectSession</span><span class="p">(</span><span class="s2">&quot;Multiwfn&quot;</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="p">))</span>
        <span class="n">session</span><span class="o">.</span><span class="n">read_available</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">_process_command</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robust_mode</span><span class="p">)</span>

        <span class="n">session</span><span class="o">.</span><span class="n">wait_for_exit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">MultiwfnRunResult</span><span class="p">(</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
            <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Multiwfn.get_charges">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_charges">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;adch&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate atomic charges.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: Charge model to use.</span>
<span class="sd">                - &#39;hirshfeld&#39;: Standard Hirshfeld charges</span>
<span class="sd">                - &#39;adch&#39;: Atomic dipole moment corrected Hirshfeld charges</span>
<span class="sd">                - &#39;vdd&#39;: Voronoi deformation density</span>
<span class="sd">                - &#39;mulliken&#39;: Mulliken charges</span>
<span class="sd">                - &#39;cm5&#39;: CM5 charges</span>
<span class="sd">                - &#39;12cm5&#39;: 1.2*CM5 charges</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If given charge model is not available.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Atomic charges indexed by atom number (1-indexed)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normalized_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_option</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">charges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">normalized_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">charges</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">charges</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">normalized_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CHARGE_MODELS</span><span class="p">:</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CHARGE_MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Charge model </span><span class="si">{</span><span class="n">model</span><span class="si">!r}</span><span class="s2"> not supported. Choose between </span><span class="si">{</span><span class="n">choices</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_wfn_input</span><span class="p">()</span> <span class="ow">and</span> <span class="n">normalized_model</span> <span class="ow">in</span> <span class="n">WFN_UNSUPPORTED_CHARGE_MODELS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">MISSING_BASIS_FUNCTION_INFORMATION_ERROR</span><span class="p">)</span>

        <span class="n">menu_pattern</span> <span class="o">=</span> <span class="n">CHARGE_MODELS</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span>
        <span class="n">menu_cmd</span> <span class="o">=</span> <span class="n">menu_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;7 Population analysis&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="n">menu_cmd</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">menu_pattern</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span>
                <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="n">expect</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;1 Use build-in sphericalized atomic&quot;</span>
                    <span class="k">if</span> <span class="n">normalized_model</span> <span class="o">!=</span> <span class="s2">&quot;mulliken&quot;</span>
                    <span class="k">else</span> <span class="s2">&quot; 1 Output Mulliken population and atomic&quot;</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;y/n&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">normalized_model</span> <span class="o">==</span> <span class="s2">&quot;mulliken&quot;</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="p">[</span><span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;Mulliken population&quot;</span><span class="p">)]</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Return&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">citation</span> <span class="o">=</span> <span class="n">CHARGE_MODEL_CITATIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">normalized_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">citation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">citation</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">normalized_model</span><span class="p">)</span>

        <span class="n">chg_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.chg&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chg_files</span><span class="p">:</span>
            <span class="n">charges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">charges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_chg_file</span><span class="p">(</span><span class="n">chg_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">charges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">charges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">charges</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span> <span class="o">=</span> <span class="n">charges</span>

        <span class="k">return</span> <span class="n">charges</span></div>


<div class="viewcode-block" id="Multiwfn.get_surface">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_surface">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;esp&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate molecular surface properties.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: Surface analysis model to use.</span>
<span class="sd">                - &#39;esp&#39;: Electrostatic Potential</span>
<span class="sd">                - &#39;alie&#39;: Average Local Ionization Energy</span>
<span class="sd">                - &#39;lea&#39;: Local Electron Affinity</span>
<span class="sd">                - &#39;leae&#39;: Local Electron Attachment Energy</span>
<span class="sd">                - &#39;electron&#39;: Electron Density</span>
<span class="sd">                - &#39;sign&#39;: Sign(lambda2)*rho</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If given model is not available.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with &#39;atomic&#39; and &#39;global&#39; keys:</span>
<span class="sd">                - &#39;atomic&#39;: Dict mapping atom index (1-based) to atomic properties</span>
<span class="sd">                    - area_total, area_positive, area_negative: Surface areas (A^2)</span>
<span class="sd">                    - min_value, max_value: Min/max function values</span>
<span class="sd">                    - avg_all, avg_positive, avg_negative: Average values</span>
<span class="sd">                    - var_all, var_positive, var_negative: Variance values</span>
<span class="sd">                - &#39;global&#39;: Dict with global surface statistics</span>
<span class="sd">                    - surface_area, volume, average, variance, minimum, maximum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normalized_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_option</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">surfaces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">normalized_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">surfaces</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">surfaces</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">normalized_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SURFACE_MODELS</span><span class="p">:</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SURFACE_MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Surface model </span><span class="si">{</span><span class="n">model</span><span class="si">!r}</span><span class="s2"> not supported. Choose between </span><span class="si">{</span><span class="n">choices</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">menu_pattern</span> <span class="o">=</span> <span class="n">SURFACE_MODELS</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span>
        <span class="n">menu_cmd</span> <span class="o">=</span> <span class="n">menu_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="s2">&quot;Tian Lu, Feiwu Chen, Quantitative analysis of molecular surface based &quot;</span>
            <span class="s2">&quot;on improved Marching Tetrahedra algorithm, J. Mol. Graph. Model., 38, &quot;</span>
            <span class="s2">&quot;314-323 (2012)&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">normalized_model</span> <span class="o">==</span> <span class="s2">&quot;esp&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Phys. Chem. Chem. Phys., 23, 20323 (2021)&quot;</span><span class="p">)</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;12 Quantitative analysis of molecular surface&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;2 Select mapped function&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="n">menu_cmd</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">menu_pattern</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Start analysis&quot;</span><span class="p">),</span>
            <span class="n">WaitProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;11 Output surface properties&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;surface facets to locsurf&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;-1 Return to upper level&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;-1 Return to main menu&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;Exit program gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">normalized_model</span><span class="p">)</span>

        <span class="n">atomic_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_surface_properties</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">global_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_global_surface_properties</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">surface_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atomic&quot;</span><span class="p">:</span> <span class="n">atomic_props</span><span class="p">,</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="n">global_props</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">surfaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">surfaces</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface_result</span>

        <span class="k">return</span> <span class="n">surface_result</span></div>


<div class="viewcode-block" id="Multiwfn.get_bond_order">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_bond_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bond_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate bond orders.</span>

<span class="sd">        Args:</span>
<span class="sd">            model: Bond order model to use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Bond order matrix as {(i, j): bond_order}.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If given bond order model is not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normalized_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_option</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">bond_orders</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">normalized_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">bond_orders</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">bond_orders</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">normalized_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BOND_ORDER_MODELS</span><span class="p">:</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">BOND_ORDER_MODELS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Bond order type &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">!r}</span><span class="s2"> not supported. Choose between </span><span class="si">{</span><span class="n">choices</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_wfn_input</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">normalized_model</span> <span class="ow">in</span> <span class="n">WFN_UNSUPPORTED_BOND_ORDER_MODELS</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">MISSING_BASIS_FUNCTION_INFORMATION_ERROR</span><span class="p">)</span>

        <span class="n">menu_pattern</span> <span class="o">=</span> <span class="n">BOND_ORDER_MODELS</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span>
        <span class="n">menu_cmd</span> <span class="o">=</span> <span class="n">menu_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">normalized_model</span> <span class="o">==</span> <span class="s2">&quot;laplacian&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s2">&quot;Tian Lu and Feiwu Chen, Bond Order Analysis Based on the Laplacian of &quot;</span>
                <span class="s2">&quot;Electron Density in Fuzzy Overlap Space, J. Phys. Chem. A, 117, &quot;</span>
                <span class="s2">&quot;3100-3108 (2013)&quot;</span>
            <span class="p">)</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;9&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;9 Bond order analysis&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="n">menu_cmd</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">menu_pattern</span><span class="p">),</span>
            <span class="n">WaitProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;current folder&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Return&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">normalized_model</span><span class="p">)</span>
        <span class="n">bond_order_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_bond_orders</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">bond_orders</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">bond_orders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">bond_orders</span><span class="p">[</span><span class="n">normalized_model</span><span class="p">]</span> <span class="o">=</span> <span class="n">bond_order_matrix</span>

        <span class="k">return</span> <span class="n">bond_order_matrix</span></div>


<div class="viewcode-block" id="Multiwfn.grid_to_descriptors">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.grid_to_descriptors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grid_to_descriptors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">grid_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">userfunction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate atomic densities from integration in fuzzy atomic spaces.</span>

<span class="sd">        Args:</span>
<span class="sd">            grid_path: Path to a grid file in .cub or .grd. If None, use the</span>
<span class="sd">                object&#39;s file_path.</span>
<span class="sd">            userfunction: User-defined function index for integration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping atom index (1-based) to integrated density value.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If input file is not a cube/grid file.</span>
<span class="sd">            FileNotFoundError: If a provided grid_path does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.cub&quot;</span><span class="p">,</span> <span class="s2">&quot;.grd&quot;</span><span class="p">}</span>
        <span class="n">grid_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">grid_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="n">grid_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">grid_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid_file</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Density analysis requires a .cub or .grd file as input.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">grid_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid file not found: </span><span class="si">{</span><span class="n">grid_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">active_grid</span> <span class="o">=</span> <span class="n">grid_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Density analysis requires a .cub or .grd file as input.&quot;</span>
                <span class="p">)</span>
            <span class="n">active_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span>

        <span class="n">grid_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">active_grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">grid_descriptors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">grid_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">grid_descriptors</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">grid_descriptors</span><span class="p">[</span><span class="n">grid_key</span><span class="p">]</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">active_grid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="n">active_grid</span>

            <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_fuzzy_integration_commands</span><span class="p">(</span>
                <span class="s2">&quot;100&quot;</span><span class="p">,</span>
                <span class="s2">&quot;100 User-defined function&quot;</span><span class="p">,</span>
                <span class="n">prefix_commands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_commands_change_iuserfunc</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">userfunction</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="n">file_path</span>

        <span class="n">grid_descriptors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_values</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">grid_descriptors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">grid_descriptors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">grid_descriptors</span><span class="p">[</span><span class="n">grid_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_descriptors</span>
        <span class="k">return</span> <span class="n">grid_descriptors</span></div>


<div class="viewcode-block" id="Multiwfn.get_grid">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">grid_quality</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">grid_file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a grid (.cub) file for a real space function.</span>

<span class="sd">        Args:</span>
<span class="sd">            descriptor: Descriptor to calculate on grid.</span>
<span class="sd">            grid_quality: Grid quality, one of &#39;low&#39;, &#39;medium&#39;, &#39;high&#39;.</span>
<span class="sd">            grid_file_name: Optional name for output cube file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path to the generated cube file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the descriptor is not supported.</span>
<span class="sd">            FileNotFoundError: If no cube file was generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">menu_cmd</span><span class="p">,</span> <span class="n">menu_pattern</span><span class="p">,</span> <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_descriptor_function</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>

        <span class="n">normalized_grid_quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_option</span><span class="p">(</span><span class="n">grid_quality</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalized_grid_quality</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GRID_QUALITIES</span><span class="p">:</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GRID_QUALITIES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Grid quality </span><span class="si">{</span><span class="n">grid_quality</span><span class="si">!r}</span><span class="s2"> not supported. Choose between </span><span class="si">{</span><span class="n">choices</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">grid_pattern</span> <span class="o">=</span> <span class="n">GRID_QUALITIES</span><span class="p">[</span><span class="n">normalized_grid_quality</span><span class="p">]</span>
        <span class="n">grid_cmd</span> <span class="o">=</span> <span class="n">grid_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">existing_cub_files</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">grid_workdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_path</span> <span class="o">/</span> <span class="n">descriptor</span>
        <span class="k">if</span> <span class="n">grid_workdir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">existing_cub_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">grid_workdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.cub&quot;</span><span class="p">))</span>

        <span class="n">grid_commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span> <span class="o">|</span> <span class="n">WaitProgress</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="o">*</span><span class="n">commands</span><span class="p">,</span>
            <span class="n">CommandStep</span><span class="p">(</span>
                <span class="s2">&quot;5&quot;</span><span class="p">,</span>
                <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;5 Output and plot specific property within a spatial region&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="n">menu_cmd</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">menu_pattern</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="n">grid_cmd</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">grid_pattern</span><span class="p">),</span>
            <span class="n">WaitProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;2 Export data to a Gaussian-type cube file&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Return to main menu&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">grid_commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">descriptor</span><span class="p">)</span>

        <span class="n">cub_candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.cub&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cub_candidates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No .cub file was generated by Multiwfn.&quot;</span><span class="p">)</span>
        <span class="n">new_cub_candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">cub_candidates</span> <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_cub_files</span>
        <span class="p">]</span>
        <span class="n">selection_pool</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">new_cub_candidates</span> <span class="k">if</span> <span class="n">new_cub_candidates</span> <span class="k">else</span> <span class="n">cub_candidates</span>
        <span class="p">)</span>
        <span class="n">cub_file_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">selection_pool</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime_ns</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">grid_file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Rename the file</span>
            <span class="n">new_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="n">grid_file_name</span>
            <span class="n">cub_file_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_path</span>

        <span class="k">return</span> <span class="n">cub_file_path</span></div>


<div class="viewcode-block" id="Multiwfn.get_fukui">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_fukui">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fukui</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate Fukui functions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with all Fukui descriptors</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the system is open-shell or spin is undefined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Fukui function analysis requires known spin state. &quot;</span>
                <span class="s2">&quot;Initialize Multiwfn with has_spin=True/False.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fukui function analysis requires closed-shell.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">fukui</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">fukui</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;22 Conceptual DFT&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;6 Calculate condensed OW Fukui&quot;</span><span class="p">),</span>
            <span class="n">WaitProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">expect</span><span class="o">=</span><span class="n">SINGLE_DETERMINANT_WFN_ERROR_PATTERN</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span>
                <span class="s2">&quot;0&quot;</span><span class="p">,</span>
                <span class="n">expect</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(Fukui potential|0 Return)&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;fukui&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_if_single_determinant_wavefunction_error</span><span class="p">(</span>
            <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="s2">&quot;Fukui function analysis&quot;</span>
        <span class="p">)</span>
        <span class="n">fukui_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_fukui</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">fukui</span> <span class="o">=</span> <span class="n">fukui_results</span>

        <span class="k">return</span> <span class="n">fukui_results</span></div>


<div class="viewcode-block" id="Multiwfn.get_superdelocalizabilities">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_superdelocalizabilities">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_superdelocalizabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate superdelocalizabilities.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with all superdelocalizability descriptors.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the system is open-shell or spin is undefined.</span>
<span class="sd">            RuntimeError: If Multiwfn reports unsupported wavefunction type or no</span>
<span class="sd">                superdelocalizability table can be parsed from output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Superdelocalizability analysis requires known spin state. &quot;</span>
                <span class="s2">&quot;Initialize Multiwfn with has_spin=True/False.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Superdelocalizability analysis requires closed-shell.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">superdelocalizabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">superdelocalizabilities</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;22&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;22 Conceptual DFT&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;8 Calculate nucleophilic and electrophilic&quot;</span><span class="p">),</span>
            <span class="n">WaitProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">expect</span><span class="o">=</span><span class="n">SINGLE_DETERMINANT_WFN_ERROR_PATTERN</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="c1"># Prompt text after option 8 varies across Multiwfn builds; send &quot;0&quot;</span>
            <span class="c1"># unconditionally to return to the previous menu.</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span>
            <span class="c1"># Do not gate quit on a specific prompt here; conceptual-DFT submenu</span>
            <span class="c1"># prompts vary across Multiwfn builds.</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;superdeloc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_if_single_determinant_wavefunction_error</span><span class="p">(</span>
            <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">analysis</span><span class="o">=</span><span class="s2">&quot;Superdelocalizability analysis&quot;</span>
        <span class="p">)</span>
        <span class="n">superdeloc_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_superdelocalizabilities</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">superdeloc_matrix</span><span class="p">[</span><span class="s2">&quot;d_n&quot;</span><span class="p">]:</span>
            <span class="n">nonempty_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="n">excerpt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nonempty_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">excerpt</span><span class="p">:</span>
                <span class="n">excerpt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Output excerpt:</span><span class="se">\n</span><span class="si">{</span><span class="n">excerpt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">SINGLE_DETERMINANT_WFN_ERROR_TEXT</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Superdelocalizability analysis returned no atomic values; &quot;</span>
                <span class="s2">&quot;Multiwfn output format may be unsupported.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">excerpt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">superdelocalizabilities</span> <span class="o">=</span> <span class="n">superdeloc_matrix</span>

        <span class="k">return</span> <span class="n">superdeloc_matrix</span></div>


<div class="viewcode-block" id="Multiwfn.get_vector">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_vector">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate atomic 3D descriptors.</span>

<span class="sd">        Args:</span>
<span class="sd">            descriptor: Descriptor name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of atomic descriptors as 3D vectors.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: for invalid descriptor input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VECTORS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vector descriptor </span><span class="si">{</span><span class="n">descriptor</span><span class="si">!r}</span><span class="s2"> not supported&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_vector_descriptors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_vector_descriptors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_vector_descriptors</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_vector_descriptors</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>

        <span class="n">menu_cmd</span> <span class="o">=</span> <span class="s2">&quot;100&quot;</span>
        <span class="n">menu_pattern</span> <span class="o">=</span> <span class="s2">&quot;100 User-defined function&quot;</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_vector_functions</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>

        <span class="n">vectors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">component_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_function_selection</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">descriptor</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_fuzzy_integration</span><span class="p">(</span>
                <span class="n">menu_cmd</span><span class="p">,</span>
                <span class="n">menu_pattern</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commands_change_iuserfunc</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">func</span><span class="p">),</span>
                <span class="n">label</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">atom_idx</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">components</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
                <span class="n">components</span><span class="p">[</span><span class="n">component_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">vectors_3d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">atom_idx</span><span class="p">:</span> <span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">atom_idx</span><span class="p">,</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">vectors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_vector_descriptors</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span> <span class="o">=</span> <span class="n">vectors_3d</span>
        <span class="k">return</span> <span class="n">vectors_3d</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_function_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">closed_shell_only</span> <span class="o">=</span> <span class="p">{</span><span class="mi">24</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">1100</span><span class="p">}</span>
        <span class="n">open_shell_only</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1101</span><span class="p">,</span> <span class="mi">1102</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">closed_shell_only</span> <span class="ow">or</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">open_shell_only</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Descriptor </span><span class="si">{</span><span class="n">descriptor</span><span class="si">!r}</span><span class="s2"> requires known spin state. &quot;</span>
                    <span class="s2">&quot;Initialize Multiwfn with has_spin=True/False.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span><span class="p">:</span>  <span class="c1"># open-shell</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">closed_shell_only</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Descriptor </span><span class="si">{</span><span class="n">descriptor</span><span class="si">!r}</span><span class="s2"> not available for open-shell systems.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># closed-shell</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">open_shell_only</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Descriptor </span><span class="si">{</span><span class="n">descriptor</span><span class="si">!r}</span><span class="s2"> not available for closed-shell systems.&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_descriptor_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALL_FUNCTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Descriptor </span><span class="si">{</span><span class="n">descriptor</span><span class="si">!r}</span><span class="s2"> not supported.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">VECTORS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Descriptor </span><span class="si">{</span><span class="n">descriptor</span><span class="si">!r}</span><span class="s2"> is vector-valued. Use get_vector() instead.&quot;</span>
            <span class="p">)</span>

        <span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="n">REAL_SPACE_FUNCTIONS</span><span class="p">:</span>
            <span class="n">menu_pattern</span> <span class="o">=</span> <span class="n">REAL_SPACE_FUNCTIONS</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>
            <span class="n">menu_cmd</span> <span class="o">=</span> <span class="n">menu_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">menu_cmd</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;13&quot;</span><span class="p">}:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Descriptor </span><span class="si">{</span><span class="n">descriptor</span><span class="si">!r}</span><span class="s2"> requires grid data!&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">function_setting</span> <span class="o">=</span> <span class="n">USER_REAL_FUNCTIONS</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">citation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_user_function</span><span class="p">(</span><span class="n">function_setting</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">citation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">citation</span><span class="p">)</span>
            <span class="n">menu_cmd</span> <span class="o">=</span> <span class="s2">&quot;100&quot;</span>
            <span class="n">menu_pattern</span> <span class="o">=</span> <span class="s2">&quot;100 User-defined function&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_function_selection</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">)</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commands_change_iuserfunc</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">func</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">menu_cmd</span><span class="p">,</span> <span class="n">menu_pattern</span><span class="p">,</span> <span class="n">commands</span>

<div class="viewcode-block" id="Multiwfn.get_descriptor">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_descriptor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_descriptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate atomic densities from integration in fuzzy atomic spaces.</span>

<span class="sd">        Args:</span>
<span class="sd">            descriptor: Descriptor name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping atom index (1-based) to integrated density value.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the descriptor is unsupported, vector-valued, requires grid</span>
<span class="sd">                data, or is incompatible with the current spin state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_descriptors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_descriptors</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_descriptors</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">menu_cmd</span><span class="p">,</span> <span class="n">menu_pattern</span><span class="p">,</span> <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_descriptor_function</span><span class="p">(</span><span class="n">descriptor</span><span class="p">)</span>
            <span class="n">descriptor_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_fuzzy_integration</span><span class="p">(</span>
                <span class="n">menu_cmd</span><span class="p">,</span> <span class="n">menu_pattern</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">descriptor</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_descriptors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_descriptors</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">atomic_descriptors</span><span class="p">[</span><span class="n">descriptor</span><span class="p">]</span> <span class="o">=</span> <span class="n">descriptor_result</span>
            <span class="k">return</span> <span class="n">descriptor_result</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_run_fuzzy_integration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">menu_cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">menu_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span><span class="p">],</span>
        <span class="n">descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">command_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_fuzzy_integration_commands</span><span class="p">(</span>
            <span class="n">menu_cmd</span><span class="p">,</span>
            <span class="n">menu_pattern</span><span class="p">,</span>
            <span class="n">prefix_commands</span><span class="o">=</span><span class="n">commands</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">command_sequence</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">descriptor</span><span class="p">)</span>
        <span class="n">descriptor_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_values</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">descriptor_result</span>

<div class="viewcode-block" id="Multiwfn.get_electric_moments">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_electric_moments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_electric_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate electric dipole/multipole moments.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">electric_moments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">electric_moments</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;300&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;300 Other functions&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;5 Calculate electric dipole/multipole moments&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Return&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;electric_moments&quot;</span><span class="p">)</span>
        <span class="n">moments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_electric_moments</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">electric_moments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">electric_moments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">electric_moments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">moments</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">moments</span></div>


<div class="viewcode-block" id="Multiwfn.get_gaps">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_gaps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_gaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">occupation_thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return orbital energies and HOMO-centered adjacent orbital gaps.</span>

<span class="sd">        Args:</span>
<span class="sd">            n: Half-window size around HOMO. A window of `n=3` spans</span>
<span class="sd">                `homo_index - 3` through `homo_index + 3`.</span>
<span class="sd">            occupation_thresholds: `(lower, upper)` thresholds used to classify</span>
<span class="sd">                unoccupied, partially occupied and occupied orbitals.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary with:</span>
<span class="sd">            - `orbitals`: `{index: (energy_ev, occupation, orbital_type)}`</span>
<span class="sd">            - `gaps`: HOMO index/energy and `sequence_ev`, where each entry is</span>
<span class="sd">              `{(i, j): gap_ev}` for adjacent orbitals `i -&gt; j`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If spin state is unknown, `n &lt; 0`, or thresholds are invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Gap analysis requires known spin state. &quot;</span>
                <span class="s2">&quot;Initialize Multiwfn with has_spin=True/False.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gap window n must be &gt;= 0.&quot;</span><span class="p">)</span>

        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_occupation_thresholds</span><span class="p">(</span><span class="n">occupation_thresholds</span><span class="p">)</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gap_cache_key</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">)</span>

        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">gap</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">cached</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="n">orbitals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orbital_listing</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;orbital_gaps&quot;</span><span class="p">)</span>
        <span class="n">gap_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_homo_window_gaps</span><span class="p">(</span>
            <span class="n">orbitals</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">occupation_thresholds</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">cached</span>
        <span class="n">cached</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">gap_result</span>
        <span class="k">return</span> <span class="n">gap_result</span></div>


<div class="viewcode-block" id="Multiwfn.get_gap">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_gap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_gap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">occupation_thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Backward-compatible alias for :meth:`get_gaps`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gaps</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">occupation_thresholds</span><span class="o">=</span><span class="n">occupation_thresholds</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_homo_lumo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate eV-based HOMO/LUMO energies and HOMO-LUMO gap.&quot;&quot;&quot;</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Show molecular structure and view orbitals&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;homo_lumo&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_homo_lumo_gap</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_somo_gaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">occupation_thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate eV-based SOMO gaps to overall HOMO and LUMO.&quot;&quot;&quot;</span>
        <span class="n">orbitals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_orbital_listing</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;somo_gaps&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_somo_gaps</span><span class="p">(</span><span class="n">orbitals</span><span class="p">,</span> <span class="n">occupation_thresholds</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_orbital_listing_commands</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CommandStep</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build command sequence for the `List all orbitals` screen.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;6 Check &amp; modify wavefunction&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;3 List all orbitals&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;-1 Return&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_orbital_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run orbital listing and parse rows.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orbital_listing_commands</span><span class="p">(),</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_orbital_list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_gap_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build deterministic cache key for gap requests.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Gap analysis requires known spin state. &quot;</span>
                <span class="s2">&quot;Initialize Multiwfn with has_spin=True/False.&quot;</span>
            <span class="p">)</span>
        <span class="n">spin_label</span> <span class="o">=</span> <span class="s2">&quot;open&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_spin</span> <span class="k">else</span> <span class="s2">&quot;closed&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spin_label</span><span class="si">}</span><span class="s2">:n:</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">:lower:</span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s2">.8g</span><span class="si">}</span><span class="s2">:upper:</span><span class="si">{</span><span class="n">upper</span><span class="si">:</span><span class="s2">.8g</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_occupation_thresholds</span><span class="p">(</span>
        <span class="n">occupation_thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate and normalize occupation thresholds.&quot;&quot;&quot;</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">occupation_thresholds</span>
        <span class="k">if</span> <span class="n">lower</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lower occupation threshold must be &gt;= 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upper</span> <span class="o">&lt;=</span> <span class="n">lower</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Upper occupation threshold must be greater than lower.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_split_orbitals_by_occupation</span><span class="p">(</span>
        <span class="n">orbitals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split orbitals into unoccupied, partially occupied and occupied groups.&quot;&quot;&quot;</span>
        <span class="n">unoccupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbitals</span> <span class="k">if</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">]</span>
        <span class="n">partially_occupied</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">orb</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbitals</span> <span class="k">if</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">upper</span>
        <span class="p">]</span>
        <span class="n">occupied</span> <span class="o">=</span> <span class="p">[</span><span class="n">orb</span> <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbitals</span> <span class="k">if</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">upper</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">unoccupied</span><span class="p">,</span> <span class="n">partially_occupied</span><span class="p">,</span> <span class="n">occupied</span>

<div class="viewcode-block" id="Multiwfn.get_localization">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.get_localization">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_localization</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate localization index from integration in fuzzy atomic spaces.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">localization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">localization</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;15&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;15 Fuzzy atomic space analysis&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;4 Calculate localization&quot;</span><span class="p">),</span>
            <span class="n">WaitProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wait</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;y/n&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;0 Return&quot;</span><span class="p">),</span>
            <span class="n">CommandStep</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="s2">&quot;gracefully&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="s2">&quot;localization&quot;</span><span class="p">)</span>
        <span class="n">localization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_localization_values</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">localization</span> <span class="o">=</span> <span class="n">localization</span>
        <span class="k">return</span> <span class="n">localization</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_atomic_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">header_keywords</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">stop_keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse atomic table with 4 float columns from stdout.</span>

<span class="sd">        Args:</span>
<span class="sd">            stdout: Output to parse</span>
<span class="sd">            header_keywords: List of strings that must all appear in the header line</span>
<span class="sd">            keys: List of 4 keys for the output dictionary</span>
<span class="sd">            stop_keyword: Optional keyword to stop parsing (e.g., &quot;Sum of&quot;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping key names to {atom_idx: value}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="n">row_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="sa">rf</span><span class="s2">&quot;\s*(\d+)\([A-Za-z][a-z]?\s*\)?\s+(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+&quot;</span>
                <span class="sa">rf</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">header_keywords</span><span class="p">):</span>
                <span class="c1"># Found the header line</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                    <span class="n">data_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data_line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">stop_keyword</span> <span class="ow">and</span> <span class="n">stop_keyword</span> <span class="ow">in</span> <span class="n">data_line</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="c1"># Parse format: &quot;     1(C        val1        val2        val3        val4&quot;</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">row_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">data_line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_raise_if_single_determinant_wavefunction_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">analysis</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise a clear error for unsupported multi-determinant wavefunctions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">SINGLE_DETERMINANT_WFN_ERROR_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analysis</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">SINGLE_DETERMINANT_WFN_ERROR_TEXT</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_fukui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse Fukui function descriptors from stdout.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_table</span><span class="p">(</span>
            <span class="n">stdout</span><span class="p">,</span>
            <span class="n">header_keywords</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Atom index&quot;</span><span class="p">,</span> <span class="s2">&quot;OW f+&quot;</span><span class="p">],</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;f_plus&quot;</span><span class="p">,</span> <span class="s2">&quot;f_minus&quot;</span><span class="p">,</span> <span class="s2">&quot;f_zero&quot;</span><span class="p">,</span> <span class="s2">&quot;dd&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_superdelocalizabilities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse superdelocalizability descriptors from stdout.</span>

<span class="sd">        Multiwfn output differs across versions/builds:</span>
<span class="sd">        - Header labels may be `D_N`/`D_E` or `DN`/`DE`</span>
<span class="sd">        - Rows may contain either 2 columns (D_N, D_E) or 4 columns</span>
<span class="sd">          (D_N, D_E, D_N_0, D_E_0)</span>

<span class="sd">        Args:</span>
<span class="sd">            stdout: Multiwfn output text containing the superdelocalizability table.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mapping with keys `d_n`, `d_e`, `d_n_0`, and `d_e_0`, each containing</span>
<span class="sd">            atom-indexed values when available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;d_n&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;d_e&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;d_n_0&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;d_e_0&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

        <span class="n">atom_header_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bAtom(?:\s+index)?\b&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">dn_header_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bD[_\s]?N\b&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">de_header_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bD[_\s]?E\b&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">row_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*(\d+)\([A-Za-z][a-z]?\s*\)?\s+(.*)$&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">atom_header_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">dn_header_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">de_header_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">data_line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data_line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="s2">&quot;sum of&quot;</span> <span class="ow">in</span> <span class="n">data_line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">break</span>

                    <span class="n">row_match</span> <span class="o">=</span> <span class="n">row_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">data_line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">row_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">NUMBER_PATTERN</span><span class="p">,</span> <span class="n">row_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;d_n&quot;</span><span class="p">][</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;d_e&quot;</span><span class="p">][</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;d_n_0&quot;</span><span class="p">][</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;d_e_0&quot;</span><span class="p">][</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_electric_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse electric moments from stdout.&quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dipole_magnitude_au&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">rf</span><span class="s2">&quot;Magnitude of dipole moment:\s*(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+a\.u\.&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;quadrupole_traceless_magnitude&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">rf</span><span class="s2">&quot;Magnitude of the traceless quadrupole moment tensor:\s*(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;quadrupole_spherical_magnitude&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">rf</span><span class="s2">&quot;Magnitude: \|Q_2\|=\s*(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;octopole_spherical_magnitude&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">rf</span><span class="s2">&quot;Magnitude: \|Q_3\|=\s*(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;electronic_spatial_extent&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">rf</span><span class="s2">&quot;Electronic spatial extent &lt;r\^2&gt;:\s*(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">),</span>
        <span class="p">}</span>

        <span class="n">moments</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">moments</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">moments</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_homo_lumo_gap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse eV-based HOMO/LUMO energies and HOMO-LUMO gap from stdout.&quot;&quot;&quot;</span>
        <span class="n">homo_match</span> <span class="o">=</span> <span class="n">HOMO_LINE_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">lumo_match</span> <span class="o">=</span> <span class="n">LUMO_LINE_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">gap_match</span> <span class="o">=</span> <span class="n">HOMO_LUMO_GAP_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">homo_match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lumo_match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">gap_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not parse HOMO/LUMO energies and HOMO-LUMO gap.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;homo_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">homo_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
            <span class="s2">&quot;homo_energy_ev&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">homo_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
            <span class="s2">&quot;lumo_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">lumo_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
            <span class="s2">&quot;lumo_energy_ev&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">lumo_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
            <span class="s2">&quot;homo_lumo_gap_ev&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">gap_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_somo_gaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">occupation_thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse orbital list and compute eV-based SOMO gaps.&quot;&quot;&quot;</span>
        <span class="n">orbitals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_orbital_list</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_somo_gaps</span><span class="p">(</span><span class="n">orbitals</span><span class="p">,</span> <span class="n">occupation_thresholds</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_somo_gaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orbitals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">occupation_thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute eV-based SOMO-related energy gaps from parsed orbital rows.&quot;&quot;&quot;</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_occupation_thresholds</span><span class="p">(</span><span class="n">occupation_thresholds</span><span class="p">)</span>
        <span class="n">unoccupied</span><span class="p">,</span> <span class="n">somos</span><span class="p">,</span> <span class="n">occupied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_orbitals_by_occupation</span><span class="p">(</span>
            <span class="n">orbitals</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">unoccupied</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Could not identify doubly occupied and unoccupied orbitals.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">somos</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No partially occupied orbitals (SOMOs) were found.&quot;</span><span class="p">)</span>

        <span class="n">overall_homo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">occupied</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">orb</span><span class="p">:</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">])</span>
        <span class="n">overall_lumo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">unoccupied</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">orb</span><span class="p">:</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">])</span>

        <span class="n">sorted_somos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">somos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">orb</span><span class="p">:</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">])</span>
        <span class="n">somo_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">somo</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">somo</span> <span class="ow">in</span> <span class="n">sorted_somos</span><span class="p">]</span>
        <span class="n">somo_to_lumo_gap_ev</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">somo_to_homo_gap_ev</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">somo</span> <span class="ow">in</span> <span class="n">sorted_somos</span><span class="p">:</span>
            <span class="n">somo_idx</span> <span class="o">=</span> <span class="n">somo</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="n">somo_to_lumo_gap_ev</span><span class="p">[</span><span class="n">somo_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">overall_lumo</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">somo</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">somo_to_homo_gap_ev</span><span class="p">[</span><span class="n">somo_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">somo</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">overall_homo</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;overall_homo_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">overall_homo</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;overall_homo_energy_ev&quot;</span><span class="p">:</span> <span class="n">overall_homo</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">],</span>
            <span class="s2">&quot;overall_lumo_index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">overall_lumo</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;overall_lumo_energy_ev&quot;</span><span class="p">:</span> <span class="n">overall_lumo</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">],</span>
            <span class="s2">&quot;somo_indices&quot;</span><span class="p">:</span> <span class="n">somo_indices</span><span class="p">,</span>
            <span class="s2">&quot;somo_to_lumo_gap_ev&quot;</span><span class="p">:</span> <span class="n">somo_to_lumo_gap_ev</span><span class="p">,</span>
            <span class="s2">&quot;somo_to_homo_gap_ev&quot;</span><span class="p">:</span> <span class="n">somo_to_homo_gap_ev</span><span class="p">,</span>
            <span class="s2">&quot;occupation_thresholds&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="n">upper</span><span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_homo_window_gaps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">orbitals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">occupation_thresholds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build HOMO-centered gap sequence with a symmetric index window.&quot;&quot;&quot;</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_occupation_thresholds</span><span class="p">(</span><span class="n">occupation_thresholds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gap window n must be &gt;= 0.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">orbitals</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No orbitals available for gap analysis.&quot;</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">partially_occupied</span><span class="p">,</span> <span class="n">occupied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_orbitals_by_occupation</span><span class="p">(</span>
            <span class="n">orbitals</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>
        <span class="p">)</span>
        <span class="c1"># Unrestricted orbital listings may contain only 1/0 occupations.</span>
        <span class="c1"># In that case, fall back to the partially occupied bucket.</span>
        <span class="n">occupied_candidates</span> <span class="o">=</span> <span class="n">occupied</span> <span class="ow">or</span> <span class="n">partially_occupied</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">occupied_candidates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not identify occupied orbitals.&quot;</span><span class="p">)</span>

        <span class="n">homo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">occupied_candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">orb</span><span class="p">:</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">])</span>
        <span class="n">homo_index</span> <span class="o">=</span> <span class="n">homo</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="n">orbital_table</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">orbitals</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
            <span class="n">orbital_table</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">],</span>
                <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">],</span>
                <span class="n">orb</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">orbital_table</span><span class="p">)</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sorted_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">homo_index</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sorted_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">homo_index</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>

        <span class="n">sequence_ev</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orbital_table</span> <span class="ow">or</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orbital_table</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">gap_ev</span> <span class="o">=</span> <span class="n">orbital_table</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">orbital_table</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sequence_ev</span><span class="o">.</span><span class="n">append</span><span class="p">({(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">gap_ev</span><span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;orbitals&quot;</span><span class="p">:</span> <span class="n">orbital_table</span><span class="p">,</span>
            <span class="s2">&quot;gaps&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;homo_index&quot;</span><span class="p">:</span> <span class="n">homo_index</span><span class="p">,</span>
                <span class="s2">&quot;homo_energy_ev&quot;</span><span class="p">:</span> <span class="n">homo</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">],</span>
                <span class="s2">&quot;sequence_ev&quot;</span><span class="p">:</span> <span class="n">sequence_ev</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_orbital_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse orbital listing from `List all orbitals` output.&quot;&quot;&quot;</span>
        <span class="n">orbitals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;energy_ev&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="s2">&quot;energy_ev&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;occupation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">match</span><span class="p">[</span><span class="s2">&quot;orbital_type&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">ORBITAL_LINE_PATTERN</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">orbitals</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not parse orbital listing from stdout.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">orbitals</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_chg_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chg_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse .chg file to {atom_idx: charge}.&quot;&quot;&quot;</span>
        <span class="n">charges</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">chg_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">charges</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">charges</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_atomic_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse fuzzy atomic space integration values from stdout.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">atomic_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">value_pattern</span> <span class="o">=</span> <span class="n">NUMBER_PATTERN</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;Atomic space&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">&quot;Value&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                    <span class="n">data_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s2">&quot;Summing up&quot;</span> <span class="ow">in</span> <span class="n">data_line</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data_line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="c1"># Parse format: &quot;    1(C )            0.00607663&quot;</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                        <span class="sa">rf</span><span class="s2">&quot;\s*(\d+)\([A-Z][a-z]?\s*\)\s+(</span><span class="si">{</span><span class="n">value_pattern</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">data_line</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">atomic_values</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">atomic_values</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_localization_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse wrapped localization index output from stdout.&quot;&quot;&quot;</span>
        <span class="n">localization</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">in_section</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">atom_value_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;(\d+)\([A-Z][a-z]?\s*\)\s*:\s*([-+]?\d*\.?\d+(?:[Ee][-+]?\d+)?)&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_section</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Localization index&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">in_section</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">localization</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">continue</span>

            <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">atom_value_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">localization</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">localization</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">localization</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_bond_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse bond order matrix from Multiwfn output.&quot;&quot;&quot;</span>
        <span class="n">bond_orders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">atom_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+)\([A-Z][a-z]?\s*\)&quot;</span><span class="p">)</span>
        <span class="n">float_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NUMBER_PATTERN</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">atom_matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">atom_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_matches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">atom_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">atom_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom_matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">float_matches</span> <span class="o">=</span> <span class="n">float_pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">float_matches</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">bond_orders</span><span class="p">[(</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">atom_j</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">float_matches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">bond_orders</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bond_orders</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;)&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">atom_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">t</span> <span class="ow">and</span> <span class="s2">&quot;)&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atom_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">atom_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">bond_orders</span><span class="p">[(</span><span class="n">atom_i</span><span class="p">,</span> <span class="n">atom_j</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">bond_orders</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_atomic_areas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse atomic surface areas section from stdout.&quot;&quot;&quot;</span>
        <span class="n">atomic_props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;Atom#   All/Positive/Negative average&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">atomic_props</span><span class="p">,</span> <span class="n">i</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">atomic_props</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;area_total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="s2">&quot;area_positive&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                        <span class="s2">&quot;area_negative&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                        <span class="s2">&quot;min_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                        <span class="s2">&quot;max_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                    <span class="p">}</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">atomic_props</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_atomic_averages</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">atomic_props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse atomic surface averages section from stdout.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">atomic_props</span><span class="p">:</span>
                        <span class="n">atomic_props</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;avg_all&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="s2">&quot;avg_positive&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                <span class="s2">&quot;avg_negative&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                                <span class="s2">&quot;var_all&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                                <span class="s2">&quot;var_positive&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                                <span class="s2">&quot;var_negative&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
        <span class="k">return</span> <span class="n">atomic_props</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_atomic_charge_separation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">atomic_props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse atomic internal charge separation section from stdout.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="n">atomic_props</span><span class="p">:</span>
                    <span class="n">atomic_props</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;pi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="s2">&quot;nu&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="s2">&quot;nu_sigma2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">atomic_props</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_atomic_surface_properties</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse atomic surface properties from stdout.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">atomic_props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;All/Positive/Negative area&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">atomic_props</span><span class="p">,</span> <span class="n">avg_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_areas</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_averages</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">atomic_props</span><span class="p">,</span> <span class="n">avg_idx</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">avg_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="s2">&quot;Atom#           Pi&quot;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_charge_separation</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">atomic_props</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="s2">&quot;Atom#      Area(Ang^2)&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">atomic_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomic_simple_table</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">atomic_props</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_atomic_simple_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse atomic surface properties from single-table format.&quot;&quot;&quot;</span>
        <span class="n">atomic_props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">atom_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">atomic_props</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;area_total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s2">&quot;min_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s2">&quot;max_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="s2">&quot;avg_all&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                    <span class="s2">&quot;var_all&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">atomic_props</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_global_surface_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse global surface properties from stdout.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">in_summary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;================= Summary of surface analysis&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">in_summary</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_summary</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;Surface analysis finished!&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_summary_minmax</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handled</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_summary_key_value</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">props</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_summary_minmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a summary line containing both minimal and maximal values.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Minimal value:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;Maximal value:&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;(Minimal value|Maximal value)\s*:\s*([-\d.+Ee]+)&quot;</span><span class="p">,</span> <span class="n">line</span>
        <span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_summary_key_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a single summary key/value line.&quot;&quot;&quot;</span>
        <span class="n">key_raw</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[()\[\]=]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">key_raw</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_first_number</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bnan\b&quot;</span><span class="p">,</span> <span class="n">rest</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
            <span class="n">props</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_first_number</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">NUMBER_PATTERN</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_float</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

<div class="viewcode-block" id="Multiwfn.parse_surfanalysis">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.Multiwfn.parse_surfanalysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_surfanalysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse surfanalysis.txt for global surface statistics.&quot;&quot;&quot;</span>
        <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;statistics&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">with</span> <span class="n">filepath</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

            <span class="n">minima_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Number of surface minima:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="n">maxima_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Number of surface maxima:\s*(\d+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">minima_match</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statistics&quot;</span><span class="p">][</span><span class="s2">&quot;num_minima&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">minima_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">maxima_match</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statistics&quot;</span><span class="p">][</span><span class="s2">&quot;num_maxima&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxima_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="n">extrema_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">rf</span><span class="s2">&quot;^\s*\*?\s*\d+\s+(</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">)\s+</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">\s+&quot;</span>
                    <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NUMBER_PATTERN</span><span class="si">}</span><span class="s2">\b&quot;</span>
                <span class="p">),</span>
                <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">extrema_pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">extrema_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statistics&quot;</span><span class="p">][</span><span class="s2">&quot;num_extrema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extrema_values</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statistics&quot;</span><span class="p">][</span><span class="s2">&quot;extrema_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">extrema_values</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statistics&quot;</span><span class="p">][</span><span class="s2">&quot;extrema_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">extrema_values</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;statistics&quot;</span><span class="p">][</span><span class="s2">&quot;extrema_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">extrema_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">extrema_values</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>
</div>



<div class="viewcode-block" id="cli">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.cli">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cli</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CLI entry point for Multiwfn.&quot;&quot;&quot;</span>
    <span class="n">partial_func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">Multiwfn</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">partial_func</span></div>



<div class="viewcode-block" id="molden2aim">
<a class="viewcode-back" href="../../api/morfeus.multiwfn.html#morfeus.molden2aim">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">molden2aim</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">molden_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;xtb.molden&quot;</span><span class="p">,</span>
    <span class="n">molden2aim_executable_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;molden2aim.exe&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize molden file using molden2aim.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: Path to working directory containing the molden2aim executable.</span>
<span class="sd">        molden_name: Name of the molden file to convert.</span>
<span class="sd">        molden2aim_executable_path: Name of the molden2aim executable.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Name of the converted molden file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">_PexpectSession</span><span class="p">(</span>
        <span class="n">base_command</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">molden2aim_executable_path</span><span class="si">}</span><span class="s2"> -i </span><span class="si">{</span><span class="n">molden_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">workdir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">build_execution_env</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Yes&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">wait_for_exit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">molden_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.molden&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_new.molden&quot;</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, Kjell Jorner
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=486e5634"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    </body>
</html>