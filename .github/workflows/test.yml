name: Testing

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - "*"

jobs:
  test:
    name: ${{ matrix.os }} / ${{ matrix.python_version }}
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu, macos, windows]
        python_version: ["3.10"]
    steps:
      - uses: actions/checkout@v3
      - name: Install Python ${{ matrix.python_version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python_version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade nox
        shell: bash
      - name: Run `nox -s tests`
        run: python -m nox -s tests-${{ matrix.python_version }}
        shell: bash
  test_xtb:
    name: ubuntu / xtb / 3.10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup conda env
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: xtb-ci
          auto-activate-base: false
          channel-priority: strict
          channels: conda-forge
          python-version: "3.10"
      - name: Install xtb and nox
        run: |
          conda install -y xtb
          xtb --version
          python -m pip install --upgrade pip
          python -m pip install --upgrade nox
        shell: bash -el {0}
      - name: Run xtb tests
        run: python -m nox -s tests-3.10 -- -m xtb
        shell: bash -el {0}
  test_multiwfn_2026_2_2:
    name: ubuntu / multiwfn / 3.10
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade pytest pytest-cov pexpect
          python -m pip install -e .
        shell: bash
      - name: Install Multiwfn binary
        run: |
          set -euxo pipefail
          ZIP_URL="http://sobereva.com/multiwfn/misc/Multiwfn_2026.2.2_bin_Linux_noGUI.zip"
          ZIP_PATH="$RUNNER_TEMP/multiwfn.zip"
          INSTALL_DIR="$RUNNER_TEMP/multiwfn-bin"

          curl -L "$ZIP_URL" -o "$ZIP_PATH"
          unzip -q "$ZIP_PATH" -d "$INSTALL_DIR"

          BIN_PATH="$(find "$INSTALL_DIR" -type f -name 'Multiwfn_noGUI' | head -n 1)"
          test -n "$BIN_PATH"
          chmod +x "$BIN_PATH"

          ln -sf "$BIN_PATH" "$INSTALL_DIR/multiwfn"
          ln -sf "$INSTALL_DIR/multiwfn" "$INSTALL_DIR/Multiwfn"
          echo "$INSTALL_DIR" >> "$GITHUB_PATH"
        shell: bash
      - name: Run multiwfn tests
        run: pytest --cov=morfeus --import-mode=importlib -s -m multiwfn
        shell: bash
  deptry:
    name: nox -s deptry
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu, macos, windows]
        python_version: ["3.10"]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
        name: Install Python
        with:
          python-version: "3.10"
      - run: pip install nox
      - name: Run `nox -s deptry`
        run: nox -s deptry
